{"version":3,"sources":["../../../lib/xlsx/xlsx.js"],"names":["fs","require","ZipStream","StreamBuf","PromishLib","utils","XmlStream","StylesXform","CoreXform","SharedStringsXform","RelationshipsXform","ContentTypesXform","AppXform","WorkbookXform","WorksheetXform","DrawingXform","theme1Xml","XLSX","module","exports","workbook","fsReadFileAsync","filename","options","Promish","resolve","reject","readFile","error","data","RelType","prototype","self","stream","exists","then","Error","createReadStream","read","close","parseRels","xform","parseStream","parseWorkbook","parseSharedStrings","reconcile","model","workbookXform","worksheetXform","drawingXform","drawingOptions","media","mediaIndex","Object","keys","drawings","forEach","name","drawing","drawingRel","drawingRels","rels","reduce","o","rel","Id","sheetOptions","styles","sharedStrings","date1904","properties","worksheets","worksheet","relationships","worksheetRels","sheetNo","worksheetHash","globalRels","workbookRels","sheetDefs","processWorksheetEntry","entry","match","path","push","undefined","processWorksheetRelsEntry","processMediaEntry","lastDot","lastIndexOf","extension","substr","streamBuf","on","length","medium","type","buffer","toBuffer","pipe","processDrawingEntry","processDrawingRelsEntry","processThemeEntry","themes","toString","processIgnoreEntry","autodrain","createInputStream","promises","ZipReader","getEntryType","promise","entryPath","sheets","definedNames","views","appXform","appProperties","assign","company","manager","coreXform","coreProperties","all","emit","catch","zipStream","load","base64","Buffer","write","end","addMedia","zip","map","append","dataimg64","content","substring","indexOf","addDrawings","relsXform","prepare","xml","toXml","addContentTypes","addApp","addCore","addThemes","theme1","addOfficeRels","Type","OfficeDocument","Target","CoreProperties","ExtenderProperties","addWorkbookRels","count","Styles","Theme","SharedStrings","rId","Worksheet","id","addSharedStrings","addStyles","addWorkbook","addWorksheets","relationshipsXform","xmlStream","render","_finalize","finalize","prepareModel","creator","lastModifiedBy","created","Date","modified","useSharedStrings","useStyles","Mock","worksheetOptions","drawingsCount","ZipWriter","afters","writeFile","createWriteStream","writeBuffer"],"mappings":"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","file":"xlsx.js","sourcesContent":["/**\n * Copyright (c) 2014 Guyon Roche\n * LICENCE: MIT - please refer to LICENCE file included with this module\n * or https://github.com/guyonroche/exceljs/blob/master/LICENSE\n */\n\n'use strict';\n\nvar fs = require('fs');\nvar ZipStream = require('../utils/zip-stream');\nvar StreamBuf = require('../utils/stream-buf');\nvar PromishLib = require('../utils/promish');\n\nvar utils = require('../utils/utils');\nvar XmlStream = require('../utils/xml-stream');\n\nvar StylesXform = require('./xform/style/styles-xform');\n\nvar CoreXform = require('./xform/core/core-xform');\nvar SharedStringsXform = require('./xform/strings/shared-strings-xform');\nvar RelationshipsXform = require('./xform/core/relationships-xform');\nvar ContentTypesXform = require('./xform/core/content-types-xform');\nvar AppXform = require('./xform/core/app-xform');\nvar WorkbookXform = require('./xform/book/workbook-xform');\nvar WorksheetXform = require('./xform/sheet/worksheet-xform');\nvar DrawingXform = require('./xform/drawing/drawing-xform');\n\nvar theme1Xml = require('./xml/theme1.js');\n\nvar XLSX = module.exports = function(workbook) {\n  this.workbook = workbook;\n};\n\nfunction fsReadFileAsync(filename, options) {\n  return new PromishLib.Promish(function(resolve, reject) {\n    fs.readFile(filename, options, function(error, data) {\n      if (error) {\n        reject(error);\n      } else {\n        resolve(data);\n      }\n    });\n  });\n}\n\nXLSX.RelType = require('./rel-type');\n\nXLSX.prototype = {\n  // ===============================================================================\n  // Workbook\n  // =========================================================================\n  // Read\n\n  readFile: function(filename) {\n    var self = this;\n    var stream;\n    return utils.fs.exists(filename)\n      .then(function(exists) {\n        if (!exists) {\n          throw new Error('File not found: ' + filename);\n        }\n        stream = fs.createReadStream(filename);\n        return self.read(stream);\n      })\n      .then(function(workbook) {\n        stream.close();\n        return workbook;\n      });\n  },\n  parseRels: function(stream) {\n    var xform = new RelationshipsXform();\n    return xform.parseStream(stream);\n  },\n  parseWorkbook: function(stream) {\n    var xform = new WorkbookXform();\n    return xform.parseStream(stream);\n  },\n  parseSharedStrings: function(stream) {\n    var xform = new SharedStringsXform();\n    return xform.parseStream(stream);\n  },\n  reconcile: function(model) {\n    var workbookXform = new WorkbookXform();\n    var worksheetXform = new WorksheetXform();\n    var drawingXform = new DrawingXform();\n\n    workbookXform.reconcile(model);\n\n    // reconcile drawings with their rels\n    var drawingOptions = {\n      media: model.media,\n      mediaIndex: model.mediaIndex,\n    };\n    Object.keys(model.drawings).forEach(function(name) {\n      var drawing = model.drawings[name];\n      var drawingRel = model.drawingRels[name];\n      if (drawingRel) {\n        drawingOptions.rels = drawingRel.reduce(\n          (o, rel) => { o[rel.Id] = rel; return o; },\n          {}\n        );\n        drawingXform.reconcile(drawing, drawingOptions);\n      }\n    });\n\n    var sheetOptions = {\n      styles: model.styles,\n      sharedStrings: model.sharedStrings,\n      media: model.media,\n      mediaIndex: model.mediaIndex,\n      date1904: model.properties && model.properties.date1904,\n      drawings: model.drawings,\n    };\n    model.worksheets.forEach(function(worksheet) {\n      worksheet.relationships = model.worksheetRels[worksheet.sheetNo];\n      worksheetXform.reconcile(worksheet, sheetOptions);\n    });\n\n    // delete unnecessary parts\n    delete model.worksheetHash;\n    delete model.worksheetRels;\n    delete model.globalRels;\n    delete model.sharedStrings;\n    delete model.workbookRels;\n    delete model.sheetDefs;\n    delete model.styles;\n    delete model.mediaIndex;\n    delete model.drawings;\n    delete model.drawingRels;\n  },\n  processWorksheetEntry: function(entry, model) {\n    var match = entry.path.match(/xl\\/worksheets\\/sheet(\\d+)[.]xml/);\n    if (match) {\n      var sheetNo = match[1];\n      var xform = new WorksheetXform();\n      return xform.parseStream(entry)\n        .then(function(worksheet) {\n          worksheet.sheetNo = sheetNo;\n          model.worksheetHash[entry.path] = worksheet;\n          model.worksheets.push(worksheet);\n        });\n    }\n    return undefined;\n  },\n  processWorksheetRelsEntry: function(entry, model) {\n    var match = entry.path.match(/xl\\/worksheets\\/_rels\\/sheet(\\d+)[.]xml.rels/);\n    if (match) {\n      var sheetNo = match[1];\n      var xform = new RelationshipsXform();\n      return xform.parseStream(entry)\n        .then(function(relationships) {\n          model.worksheetRels[sheetNo] = relationships;\n        });\n    }\n    return undefined;\n  },\n  processMediaEntry: function(entry, model) {\n    var match = entry.path.match(/xl\\/media\\/([a-zA-Z0-9]+[.][a-zA-Z0-9]{3,4})$/);\n    if (match) {\n      var filename = match[1];\n      var lastDot = filename.lastIndexOf('.');\n      if (lastDot === -1) {\n        // if we can't determine extension, ignore it\n        return undefined;\n      }\n      var extension = filename.substr(lastDot + 1);\n      var name = filename.substr(0, lastDot);\n      return new PromishLib.Promish(function(resolve, reject) {\n        var streamBuf = new StreamBuf();\n        streamBuf.on('finish', function() {\n          model.mediaIndex[filename] = model.media.length;\n          model.mediaIndex[name] = model.media.length;\n          var medium = {\n            type: 'image',\n              name: name,\n            extension: extension,\n            buffer: streamBuf.toBuffer(),\n          };\n          model.media.push(medium);\n          resolve();\n        });\n        entry.on('error', function(error) {\n          reject(error);\n        });\n        entry.pipe(streamBuf);\n      });\n    }\n    return undefined;\n  },\n  processDrawingEntry: function(entry, model) {\n    var match = entry.path.match(/xl\\/drawings\\/([a-zA-Z0-9]+)[.]xml/);\n    if (match) {\n      var name = match[1];\n      var xform = new DrawingXform();\n      return xform.parseStream(entry)\n        .then(function(drawing) {\n          model.drawings[name] = drawing;\n        });\n    }\n    return undefined;\n  },\n  processDrawingRelsEntry: function(entry, model) {\n    var match = entry.path.match(/xl\\/drawings\\/_rels\\/([a-zA-Z0-9]+)[.]xml[.]rels/);\n    if (match) {\n      var name = match[1];\n      var xform = new RelationshipsXform();\n      return xform.parseStream(entry)\n        .then(function(relationships) {\n          model.drawingRels[name] = relationships;\n        });\n    }\n    return undefined;\n  },\n  processThemeEntry: function(entry, model) {\n    var match = entry.path.match(/xl\\/theme\\/([a-zA-Z0-9]+)[.]xml/);\n    if (match) {\n      return new PromishLib.Promish(function(resolve, reject) {\n        var name = match[1];\n        // TODO: stream entry into buffer and store the xml in the model.themes[]\n        var stream = new StreamBuf();\n        entry.on('error', reject);\n        stream.on('error', reject);\n        stream.on('finish', function() {\n          model.themes[name] = stream.read().toString();\n          resolve();\n        });\n        entry.pipe(stream);\n      });\n    }\n    return undefined;\n  },\n  processIgnoreEntry: function(entry) {\n    entry.autodrain();\n  },\n  createInputStream: function() {\n    var self = this;\n    var model = {\n      worksheets: [],\n      worksheetHash: {},\n      worksheetRels: [],\n      themes: {},\n      media: [],\n      mediaIndex: {},\n      drawings: {},\n      drawingRels: {},\n    };\n\n    // we have to be prepared to read the zip entries in whatever order they arrive\n    var promises = [];\n    var stream = new ZipStream.ZipReader({\n      getEntryType: path => (path.match(/xl\\/media\\//) ? 'nodebuffer' : 'string'),\n    });\n    stream.on('entry', function(entry) {\n      var promise = null;\n\n      var entryPath = entry.path;\n      if (entryPath[0] === '/') {\n        entryPath = entryPath.substr(1);\n      }\n      switch (entryPath) {\n        case '_rels/.rels':\n          promise = self.parseRels(entry)\n            .then(function(relationships) {\n              model.globalRels = relationships;\n            });\n          break;\n\n        case 'xl/workbook.xml':\n          promise = self.parseWorkbook(entry)\n            .then(function(workbook) {\n              model.sheets = workbook.sheets;\n              model.definedNames = workbook.definedNames;\n              model.views = workbook.views;\n              model.properties = workbook.properties;\n            });\n          break;\n\n        case 'xl/_rels/workbook.xml.rels':\n          promise = self.parseRels(entry)\n            .then(function(relationships) {\n              model.workbookRels = relationships;\n            });\n          break;\n\n        case 'xl/sharedStrings.xml':\n          model.sharedStrings = new SharedStringsXform();\n          promise = model.sharedStrings.parseStream(entry);\n          break;\n\n        case 'xl/styles.xml':\n          model.styles = new StylesXform();\n          promise = model.styles.parseStream(entry);\n          break;\n\n        case 'docProps/app.xml':\n          var appXform = new AppXform();\n          promise = appXform.parseStream(entry)\n            .then(function(appProperties) {\n              Object.assign(model, {\n                company: appProperties.company,\n                manager: appProperties.manager\n              });\n            });\n          break;\n\n        case 'docProps/core.xml':\n          var coreXform = new CoreXform();\n          promise = coreXform.parseStream(entry)\n            .then(function(coreProperties) {\n              Object.assign(model, coreProperties);\n            });\n          break;\n\n        default:\n          promise =\n            self.processWorksheetEntry(entry, model) ||\n            self.processWorksheetRelsEntry(entry, model) ||\n            self.processThemeEntry(entry, model) ||\n            self.processMediaEntry(entry, model) ||\n            self.processDrawingEntry(entry, model) ||\n            self.processDrawingRelsEntry(entry, model) ||\n            self.processIgnoreEntry(entry);\n          break;\n      }\n\n      if (promise) {\n        promises.push(promise);\n        promise = null;\n      }\n    });\n    stream.on('finished', function() {\n      PromishLib.Promish.all(promises)\n        .then(function() {\n          self.reconcile(model);\n\n          // apply model\n          self.workbook.model = model;\n        })\n        .then(function() {\n          stream.emit('done');\n        })\n        .catch(function(error) {\n          stream.emit('error', error);\n        });\n    });\n    return stream;\n  },\n\n  read: function(stream) {\n    var self = this;\n    var zipStream = this.createInputStream();\n    return new PromishLib.Promish(function(resolve, reject) {\n      zipStream.on('done', function() {\n        resolve(self.workbook);\n      }).on('error', function(error) {\n        reject(error);\n      });\n      stream.pipe(zipStream);\n    });\n  },\n\n  load: function(data, options) {\n    var self = this;\n    if (options === undefined) {\n      options = {};\n    }\n    var zipStream = this.createInputStream();\n    return new PromishLib.Promish(function(resolve, reject) {\n      zipStream.on('done', function() {\n        resolve(self.workbook);\n      }).on('error', function(error) {\n        reject(error);\n      });\n\n      if (options.base64) {\n        var buffer = new Buffer(data.toString(), 'base64');\n        zipStream.write(buffer);\n      } else {\n        zipStream.write(data);\n      }\n      zipStream.end();\n    });\n  },\n\n  // =========================================================================\n  // Write\n\n  addMedia: function(zip, model) {\n    return PromishLib.Promish.all(model.media.map(function(medium) {\n      if (medium.type === 'image') {\n        var filename = 'xl/media/' + medium.name + '.' + medium.extension;\n        if (medium.filename) {\n          return fsReadFileAsync(medium.filename)\n            .then(function(data) {\n              zip.append(data, {name: filename});\n            });\n        }\n        if (medium.buffer) {\n          return new PromishLib.Promish(function(resolve) {\n            zip.append(medium.buffer, {name: filename});\n            resolve();\n          });\n        }\n        if (medium.base64) {\n          return new PromishLib.Promish(function(resolve) {\n            var dataimg64 = medium.base64;\n            var content = dataimg64.substring(dataimg64.indexOf(',') + 1);\n            zip.append(content, { name: filename, base64: true });\n            resolve();\n          });\n        }\n      }\n      return PromishLib.Promish.reject(new Error('Unsupported media'));\n    }));\n  },\n\n  addDrawings: function(zip, model) {\n    var drawingXform = new DrawingXform();\n    var relsXform = new RelationshipsXform();\n    var promises = [];\n\n    model.worksheets.forEach(function(worksheet) {\n      var drawing = worksheet.drawing;\n      if (drawing) {\n        promises.push(new PromishLib.Promish(function(resolve) {\n          drawingXform.prepare(drawing, {});\n          var xml = drawingXform.toXml(drawing);\n          zip.append(xml, {name: 'xl/drawings/' + drawing.name + '.xml'});\n\n          xml = relsXform.toXml(drawing.rels);\n          zip.append(xml, {name: 'xl/drawings/_rels/' + drawing.name + '.xml.rels'});\n\n          resolve();\n        }));\n      }\n    });\n\n    return PromishLib.Promish.all(promises);\n  },\n\n  addContentTypes: function(zip, model) {\n    return new PromishLib.Promish(function(resolve) {\n      var xform = new ContentTypesXform();\n      var xml = xform.toXml(model);\n      zip.append(xml, {name: '[Content_Types].xml'});\n      resolve();\n    });\n  },\n\n  addApp: function(zip, model) {\n    return new PromishLib.Promish(function(resolve) {\n      var xform = new AppXform();\n      var xml = xform.toXml(model);\n      zip.append(xml, {name: 'docProps/app.xml'});\n      resolve();\n    });\n  },\n\n  addCore: function(zip, model) {\n    return new PromishLib.Promish(function(resolve) {\n      var coreXform = new CoreXform();\n      zip.append(coreXform.toXml(model), {name: 'docProps/core.xml'});\n      resolve();\n    });\n  },\n\n  addThemes: function(zip, model) {\n    return new PromishLib.Promish(function(resolve) {\n      var themes = model.themes || { theme1: theme1Xml };\n      Object.keys(themes).forEach(function(name) {\n        var xml = themes[name];\n        var path = 'xl/theme/' + name + '.xml';\n        zip.append(xml, {name: path});\n      });\n      resolve();\n    });\n  },\n\n  addOfficeRels: function(zip) {\n    return new PromishLib.Promish(function(resolve) {\n      var xform = new RelationshipsXform();\n      var xml = xform.toXml([\n          {Id: 'rId1', Type: XLSX.RelType.OfficeDocument, Target: 'xl/workbook.xml'},\n          {Id: 'rId2', Type: XLSX.RelType.CoreProperties, Target: 'docProps/core.xml'},\n          {Id: 'rId3', Type: XLSX.RelType.ExtenderProperties, Target: 'docProps/app.xml'}\n        ]);\n      zip.append(xml, {name: '_rels/.rels'});\n      resolve();\n    });\n  },\n\n  addWorkbookRels: function(zip, model) {\n    var count = 1;\n    var relationships = [\n        {Id: 'rId' + (count++), Type: XLSX.RelType.Styles, Target: 'styles.xml'},\n        {Id: 'rId' + (count++), Type: XLSX.RelType.Theme, Target: 'theme/theme1.xml'}\n    ];\n    if (model.sharedStrings.count) {\n      relationships.push(\n        {Id: 'rId' + (count++), Type: XLSX.RelType.SharedStrings, Target: 'sharedStrings.xml'}\n      );\n    }\n    model.worksheets.forEach(function(worksheet) {\n      worksheet.rId = 'rId' + (count++);\n      relationships.push(\n        {Id: worksheet.rId, Type: XLSX.RelType.Worksheet, Target: 'worksheets/sheet' + worksheet.id + '.xml'}\n      );\n    });\n    return new PromishLib.Promish(function(resolve) {\n      var xform = new RelationshipsXform();\n      var xml = xform.toXml(relationships);\n      zip.append(xml, {name: 'xl/_rels/workbook.xml.rels'});\n      resolve();\n    });\n  },\n  addSharedStrings: function(zip, model) {\n    if (!model.sharedStrings || !model.sharedStrings.count) {\n      return PromishLib.Promish.resolve();\n    }\n    return new PromishLib.Promish(function(resolve) {\n      zip.append(model.sharedStrings.xml, {name: 'xl/sharedStrings.xml'});\n      resolve();\n    });\n  },\n  addStyles: function(zip, model) {\n    return new PromishLib.Promish(function(resolve) {\n      var xml = model.styles.xml;\n      if (xml) {\n        zip.append(xml, {name: 'xl/styles.xml'});\n      }\n      resolve();\n    });\n  },\n  addWorkbook: function(zip, model) {\n    return new PromishLib.Promish(function(resolve) {\n      var xform = new WorkbookXform();\n      zip.append(xform.toXml(model), {name: 'xl/workbook.xml'});\n      resolve();\n    });\n  },\n  addWorksheets: function(zip, model) {\n    return new PromishLib.Promish(function(resolve) {\n      // preparation phase\n      var worksheetXform = new WorksheetXform();\n      var relationshipsXform = new RelationshipsXform();\n\n      // write sheets\n      model.worksheets.forEach(function(worksheet) {\n        var xmlStream = new XmlStream();\n        worksheetXform.render(xmlStream, worksheet);\n        zip.append(xmlStream.xml, {name: 'xl/worksheets/sheet' + worksheet.id + '.xml'});\n\n        if (worksheet.rels && worksheet.rels.length) {\n          xmlStream = new XmlStream();\n          relationshipsXform.render(xmlStream, worksheet.rels);\n          zip.append(xmlStream.xml, {name: 'xl/worksheets/_rels/sheet' + worksheet.id + '.xml.rels'});\n        }\n      });\n\n      resolve();\n    });\n  },\n  _finalize: function(zip) {\n    return new PromishLib.Promish((resolve, reject) => {\n      zip.on('finish', () => {\n        resolve(this);\n      });\n      zip.on('error', reject);\n      zip.finalize();\n    });\n  },\n  prepareModel: function(model, options) {\n    // ensure following properties have sane values\n    model.creator = model.creator || 'ExcelJS';\n    model.lastModifiedBy = model.lastModifiedBy || 'ExcelJS';\n    model.created = model.created || new Date();\n    model.modified = model.modified || new Date();\n\n    model.useSharedStrings = options.useSharedStrings !== undefined ?\n      options.useSharedStrings :\n      true;\n    model.useStyles = options.useStyles !== undefined ?\n      options.useStyles :\n      true;\n\n    // Manage the shared strings\n    model.sharedStrings = new SharedStringsXform();\n\n    // add a style manager to handle cell formats, fonts, etc.\n    model.styles = model.useStyles ? new StylesXform(true) : new StylesXform.Mock();\n\n    // prepare all of the things before the render\n    var workbookXform = new WorkbookXform();\n    var worksheetXform = new WorksheetXform();\n\n    workbookXform.prepare(model);\n\n    var worksheetOptions = {\n      sharedStrings: model.sharedStrings,\n      styles: model.styles,\n      date1904: model.properties.date1904,\n      drawingsCount: 0,\n      media: model.media,\n    };\n    worksheetOptions.drawings = model.drawings = [];\n    model.worksheets.forEach(function(worksheet) {\n      worksheetXform.prepare(worksheet, worksheetOptions);\n    });\n\n    // TODO: workbook drawing list\n  },\n  write: function(stream, options) {\n    options = options || {};\n    var model = this.workbook.model;\n    var zip = new ZipStream.ZipWriter();\n    zip.pipe(stream);\n\n    this.prepareModel(model, options);\n\n    // render\n    return PromishLib.Promish.resolve()\n      .then(() => this.addContentTypes(zip, model))\n      .then(() => this.addOfficeRels(zip, model))\n      .then(() => this.addWorkbookRels(zip, model))\n      .then(() => this.addWorksheets(zip, model))\n      .then(() => this.addSharedStrings(zip, model)) // always after worksheets\n      .then(() => this.addDrawings(zip, model))\n      .then(() => {\n        var promises = [\n          this.addThemes(zip, model),\n          this.addStyles(zip, model),\n        ];\n        return PromishLib.Promish.all(promises);\n      })\n      .then(() => this.addMedia(zip, model))\n      .then(() => {\n        var afters = [\n          this.addApp(zip, model),\n          this.addCore(zip, model),\n        ];\n        return PromishLib.Promish.all(afters);\n      })\n      .then(() => this.addWorkbook(zip, model))\n      .then(() => this._finalize(zip));\n  },\n  writeFile: function(filename, options) {\n    var self = this;\n    var stream = fs.createWriteStream(filename);\n\n    return new PromishLib.Promish(function(resolve, reject) {\n      stream.on('finish', function() {\n        resolve();\n      });\n      stream.on('error', function(error) {\n        reject(error);\n      });\n\n      self.write(stream, options)\n        .then(function() {\n          stream.end();\n        })\n        .catch(function(error) {\n          reject(error);\n        });\n    });\n  },\n  writeBuffer: function(options) {\n    var self = this;\n    var stream = new StreamBuf();\n    return self.write(stream, options)\n      .then(function() {\n        return stream.read();\n      });\n  }\n};\n"]}