{"version":3,"sources":["../../../lib/utils/zip-stream.js"],"names":["events","require","PromishLib","JSZip","utils","StreamBuf","ZipReader","options","count","jsZip","stream","on","_process","getEntryType","inherits","EventEmitter","_finished","Promish","resolve","then","emit","content","read","loadAsync","zip","forEach","path","entry","dir","async","entryStream","write","data","autodrain","catch","error","encoding","callback","cork","uncork","end","ZipWriter","append","hasOwnProperty","base64","file","name","finalize","type","compression","generateAsync","size","setEncoding","pause","resume","isPaused","pipe","destination","unpipe","unshift","chunk","wrap","module","exports"],"mappings":"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","file":"zip-stream.js","sourcesContent":["/**\n * Copyright (c) 2016-2017 Guyon Roche\n * LICENCE: MIT - please refer to LICENCE file included with this module\n * or https://github.com/guyonroche/exceljs/blob/master/LICENSE\n */\n\n'use strict';\n\n// The purpose of this module is to wrap the js-zip library into a streaming zip library\n// since most of the exceljs code uses streams.\n// One day I might find (or build) a properly streaming browser safe zip lib\n\nvar events = require('events');\nvar PromishLib = require('./promish');\n\nvar JSZip = require('jszip');\n\nvar utils = require('./utils');\nvar StreamBuf = require('./stream-buf');\n\n\n// =============================================================================\n// The ZipReader class\n// Unpacks an incoming zip stream\nvar ZipReader = function(options) {\n  this.count = 0;\n  this.jsZip = new JSZip();\n  this.stream = new StreamBuf();\n  this.stream.on('finish', () => {\n    this._process();\n  });\n  this.getEntryType = options.getEntryType || (() => 'string');\n};\n\nutils.inherits(ZipReader, events.EventEmitter, {\n  _finished: function() {\n    if (!--this.count) {\n      PromishLib.Promish.resolve()\n        .then(() => {\n          this.emit('finished');\n        });\n    }\n  },\n  _process: function() {\n    var content = this.stream.read();\n    this.jsZip.loadAsync(content)\n      .then(zip => {\n        zip.forEach((path, entry) => {\n          if (!entry.dir) {\n            this.count++;\n            entry.async(this.getEntryType(path))\n              .then(data => {\n                var entryStream = new StreamBuf();\n                entryStream.path = path;\n                entryStream.write(data);\n                entryStream.autodrain = () => {\n                  this._finished();\n                };\n                entryStream.on('finish', () => {\n                  this._finished();\n                });\n\n                this.emit('entry', entryStream);\n              })\n              .catch(error => {\n                this.emit('error', error);\n              });\n          }\n        });\n      })\n      .catch(error => {\n        this.emit('error', error);\n      });\n  },\n\n  // ==========================================================================\n  // Stream.Writable interface\n  write: function(data, encoding, callback) {\n    return this.stream.write(data, encoding, callback);\n  },\n  cork: function() {\n    return this.stream.cork();\n  },\n  uncork: function() {\n    return this.stream.uncork();\n  },\n  end: function() {\n    return this.stream.end();\n  }\n});\n\n// =============================================================================\n// The ZipWriter class\n// Packs streamed data into an output zip stream\nvar ZipWriter = function() {\n  this.zip = new JSZip();\n  this.stream = new StreamBuf();\n};\n\nutils.inherits(ZipWriter, events.EventEmitter, {\n\n  append: function(data, options) {\n    if (options.hasOwnProperty('base64') && options.base64) {\n      this.zip.file(options.name, data, { base64: true });\n    } else {\n      this.zip.file(options.name, data);\n    }\n  },\n  finalize: function() {\n    var options = {\n      type: 'nodebuffer',\n      compression: 'DEFLATE'\n    };\n    return this.zip.generateAsync(options)\n      .then(content => {\n        this.stream.end(content);\n        this.emit('finish');\n      });\n  },\n\n  // ==========================================================================\n  // Stream.Readable interface\n  read: function(size) {\n    return this.stream.read(size);\n  },\n  setEncoding: function(encoding) {\n    return this.stream.setEncoding(encoding);\n  },\n  pause: function() {\n    return this.stream.pause();\n  },\n  resume: function() {\n    return this.stream.resume();\n  },\n  isPaused: function() {\n    return this.stream.isPaused();\n  },\n  pipe: function(destination, options) {\n    return this.stream.pipe(destination, options);\n  },\n  unpipe: function(destination) {\n    return this.stream.unpipe(destination);\n  },\n  unshift: function(chunk) {\n    return this.stream.unshift(chunk);\n  },\n  wrap: function(stream) {\n    return this.stream.wrap(stream);\n  }\n});\n\n// =============================================================================\n\nmodule.exports = {\n  ZipReader: ZipReader,\n  ZipWriter: ZipWriter\n};\n"]}